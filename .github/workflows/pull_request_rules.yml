name: PR Validation

on:
  pull_request:
    types:
      - opened
      - synchronize

jobs:
  validate_pr:
    runs-on: ubuntu-latest

    steps:
      - name: Check file changes and added lines
        id: pr_stats
        run: |
          changes=$(curl -s -H "Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}" \
            "https://api.github.com/repos/${{ github.repository }}/pulls/${{ github.event.pull_request.number }}/files" \
            | jq '.[] | select(.status != "removed")')
          echo "::set-output name=changes::$changes"
        
      - name: Refuse PR
        uses: actions/github-script@v4
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const prFiles = ${{ steps.pr_stats.outputs.changes }};
            let totalFileChanges = 0;
            let totalAddedLines = 0;

            for (const file of prFiles) {
              totalFileChanges++;
              totalAddedLines += file.additions;
            }

            if (totalFileChanges > 1 || totalAddedLines > 1) {
              const prNumber = context.payload.pull_request.number;
              const owner = context.payload.repository.owner.login;
              const repo = context.payload.repository.name;
              const comment = `Sorry, your pull request exceeds the file changes and added lines limit. Please make sure your changes comply with our guidelines.`;

              const body = {
                owner: owner,
                repo: repo,
                issue_number: prNumber,
                body: comment
              };

              await github.issues.createComment(body);

              const declineBody = {
                owner: owner,
                repo: repo,
                pull_number: prNumber,
                state: "closed"
              };

              await github.pulls.update(declineBody);
            }
            }

